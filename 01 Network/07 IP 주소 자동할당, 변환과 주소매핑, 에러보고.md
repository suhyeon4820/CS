## 07. IP 주소 자동할당, 변환과 주소매핑, 에러보고

### 1. DHCP와 NAT

#### 1) DHCP의 필요성

- 소규모 네트워크의 경우 각각의 IP주소를 직접 분배 및 관리 가능

- 그러나, 대규모의 네트워크의 경우 직접 분배와 관리가 어려움
  - DHCP가 부재 시 네트워크 관리자는 모든 클라이언트의 통신에 필요한 정보를 직접 입력 및 관리해야 함
- IP를 보다 효율적으로 할당하고 관리하기 위해 필요
- DHCP(Dynamic Host Configuration Protocol)는 정적 및 동적 할당을 제공
- 동적 주소 할당
  - DHCP 클라이언트가 DHCP 서버에 요청, 서버는 먼저 정적 데이터베이스를 검사
  - 요청된 실제 주소가 정적 데이터베이스에 존재하면 클라이언트의 영구 IP주소가 반환
  - 항목이 정적 데이터베이스에 없으면 서버는 사용 가능한 풀에서 IP 주소를 선택
  - DHCP는 제한된 시간 동안 임시 IP 주소를 제공
- 정적 주소 할당
  - DHCP 서버에는 물리적 주소를 IP 주소에 정적으로 바인드하는 데이터베이스가 존재
  - DHCP는 서버 측은 67 / UDP, 클라이언트 측은 68 / UDP 포트 사용

#### 2) NAT의 필요

- 공인 IP주소의 수 부족
- 외부로부터 내부망을 보호
  - 내부를 사설 IP로 구성하여 외부로부터의 공격으로부터 보호
- ISP변경에 따른 내부 IP변경 최소화

#### 3) NAT

- Network Address Translation의 약자

- NAT를 사용하면 사용자는 내부적으로 많은 수의 주소 세트를 가질 수 있음

- 외부에서 하나의 주소 또는 작은 주소 세트를 가질 수 있음

- 3개의 주소 세트를 개인 주소로 정해놓음
  
  - 내부를 사설 IP로 구성하여 외부로부터의 공격으로부터 보호
  
    <img src = "\Image\07\01.png">
  
- NAT은 그룹 내에서는 고유한 주소를 갖음
  
  - 내부를 사설 IP로 구성하여 외부로부터의 공격으로부터 보호
  
- 데이터를 주고 받는 경우, 모든 데이터는 NAT 라우터(공인된 하나의 주소로 변환)를 통과	

  <img src = "\Image\07\02.png" width = "550">

- 단일 주소 사용
  - 단일주소를 사용하기 위해서는 **항상 사설 네트워크에서 시작되야함**
  - **사설 네트워크에서** NAT를 사용할 경우
    
    - 네트워크 외부의 클라이언트에 대해 **서버 프로그램 실행 불가능**
    
    <img src = "\Image\07\03.png">
  
- 여러 IP 주소 사용
  - 사설 네트워크 호스트의 경우, 각 주소를 한 쌍으로 연결
    - 동일한 외부 호스트와 동시에 통신 가능
  - 정적 NAT
    - 사설 IP주소와 전역IP 주소 사이에 정적 맵핑
    - 기관 내에서 시스템으 실제 IP주소를 은신 가능
  - 동적 NAT
    - Pool에서 IP주소 할당
  
- IP주소와 포트 모두 사용
  - 오버로딩 / 포트 주소 변환(PAT)라고 부름
  
  - 주소와 포트의 조합은 패킷을 전송할 사설 네트워크 호스트를 정의
  
    <img src = "\Image\07\04.png">



### 2. 주소 매핑과 에러보고

#### 1) 주소 매핑

- IP주소는 논리적인 주소로, 인터넷에 접속된 컴퓨터를 구분
  - **인터넷 전체에서 IP 주소로 식별**
- Ethernet 주소는 물리적인 주소로, 해당 LAN에 접속된 컴퓨터를 구분
  - **MAC 주소는 LAN에서만 유일하게 식별**
  - **MAC 주소는 LAN내에서 각 장치 구분**
- IP 패킷이 해당 LAN을 통과하기 위해 **IP 주소에 대응하는 이더넷 주소와의 관계가 설정되어야함**
- 매번 네트워크를 통과할 때마다 IP주소와 MAC 주소와의 매핑이 필요
  - 정적 매핑 (Static Mapping)
  - 동적 매핑 (Dynamic Mapping)



#### 2) 정적 매핑 (Static Mapping)

- IP주소와 MAC 주소를 연결시키는 테이블을 고정적으로 생성하는 방법
  - 수작업으로 직접 입력도 가능
- 이 방법에는 문제점이 존재
  - 컴퓨터가 **NIC(Network Interface Card)를 교환** 가능
  - **이동이 가능한 컴퓨터**는 하나의 네트워크에서 다른 네트워크로 이동 가능



#### 3) 동적 매핑 (Dynamic Mapping)

- 컴퓨터가 매번 IP주소와 MAC 주소의 관계를 **프로토콜을 이용**하여 구함
- Address Resolution Protocol(ARP)
  - **IP주소에 대응하는 MAC 주소를 구하는 프로토콜**
- Reverse Address Resolution Protocol(RARP)
  - **MAC 주소에 대응하는 IP 주소를 구하는 프로토콜**
  - 현재는 DHCP가 사용



#### 4) ARP의 동작

<img src = "\Image\07\05.png" width = "500">



#### 5) 에러보고 (ICMP)

- The Internet Control Message Protocol(ICMP)
  
  - IP의 단점을 보완하기 위해서 제공
  
- IP 프로토콜은 **에러제어와 관리기능이 부족**

- **에러보고 메시지 (Error-reporting messages)**

- **질의응답 메시지(Query messages)**

- ICMP는 에러를 정정하지는 않고 **단순히 보고**만 수행

  <img src = "\Image\07\06.png" width = "500">



#### 6) 에러 보고 기능

- 목적지 도달 불가(Destination unreachable)
  - **IP패킷을 전달할 수 없을 때**, 해당 패킷은 폐기
  - 목적지 도달불가 메시지를 송신지로 전송
- 송신지 조절(Source quench)
  - 라우터나 컴퓨터는 **혼잡이 발생하면** 해당 패킷은 폐기
  - 송신지로 송신지 조절 메시지를 전송
- 시간 초과(Time exceeded)
  - 라우터는 **TTL 필드의 값이 0인 패킷**은 폐기
  - 송신지로 시간초과 메시지가 발생
  - **단편화된 메시지가 모두 도착하지 못해** 완전한 하나의 패킷을 조합할 수 없을 때 시간 초과 메시지가 발생
- 파라미터 문제 (Parameter problem)
  
  - IP 패킷 **헤더의 정보 중에서 처리할 수 없는 부분**을 발견 시
- 경로 재설정 (Redirection)
  
  - **잘못된 라우터로 패킷을 전달하는 경우**
  
  <img src = "\Image\07\07.png" width = "500">



#### 7) 질의 응답(Query)

- ICMP는 **네트워크 문제를 진단**하기 위한 행위를 할 수 있음
  - 에코 요청 및 응답 (Echo request and reply)
  
  - 타임 스탬프 요청 및 응답 (Time stamp request and reply)
  
  - 주소 마스크 요청 및 응답 (Address mask request and reply)
  
  - 라우터 요청 및 응답 (Router solicitation and advertisement)
  
    <img src = "\Image\07\08.png" width = "500">